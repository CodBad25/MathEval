{"version":3,"file":"figureApigeom-Psdmf2IH.js","sources":["../../src/lib/figureApigeom.ts"],"sourcesContent":["import type Exercice from '../exercices/Exercice'\nimport type Figure from 'apigeom'\nimport { context } from '../modules/context'\nimport { globalOptions } from '../../src/lib/stores/generalStore'\nimport { canOptions } from '../../src/lib/stores/canStore'\nimport { get } from 'svelte/store'\n\n/**\n * - Insère une figure apigeom dans la sortie HTML de l'exercice\n *\n * - defaultAction permet de sélectionner le bouton activé par défaut (bouton qui doit être présent dans la toolbar de la figure)\n *\n * - L'id est générée automatiquement avec le numéro de l'exercice et de la question\n *\n * - Si une même question a plusieurs figures, il faut ajouter un idAddendum (par exemple 'Correction' pour la figure de correction)\n */\nexport default function figureApigeom({\n  exercice,\n  figure,\n  animation = false,\n  i,\n  defaultAction,\n  idAddendum = '',\n  isDynamic,\n}: {\n  exercice: Exercice\n  figure: Figure\n  animation?: boolean\n  i: number\n  /** identifiant supplémentaire pour identifier l'\n   * si c'est la figure de la correction ou une 2e figure dans la question\n   */\n  idAddendum?: string\n  /** Action en cours au lancement de l'exercice qui doit obligatoirement être un bouton de la toolbar */\n  defaultAction?: string\n  /** figure chargé en interactif et pourtant on souhaite qu'elle soit statique => isDynamic = false */\n  isDynamic?: boolean\n}): string {\n  if (!context.isHtml) return ''\n  // Styles par défaut\n  figure.isDynamic = isDynamic !== undefined ? isDynamic : !!exercice.interactif\n  figure.divButtons.style.display = figure.isDynamic ? 'grid' : 'none'\n  figure.divUserMessage.style.fontSize = '1em'\n  figure.divUserMessage.style.pointerEvents = 'none'\n  figure.divUserMessage.style.removeProperty('color')\n  figure.divUserMessage.classList.add('text-coopmaths-struct')\n  if (!exercice.interactif) {\n    figure.divUserMessage.style.display = 'none'\n  }\n  const idApigeom = `apigeomEx${exercice.numeroExercice}F${i}${idAddendum}`\n  figure.id = idApigeom\n\n  // Pour revoir la copie de l'élève dans Capytale\n  // Attention, la clé de answers[] doit contenir apigeom, c'est pourquoi l'id est généré par cette fonction\n  function idApigeomFunct(event: Event): void {\n    if (!figure.container) {\n      // figure effacée, donc on annule la mise à jour...\n      document.removeEventListener(idApigeom, idApigeomFunct)\n      return\n    }\n    const customEvent = event as CustomEvent\n    const json = customEvent.detail\n    figure.loadJson(JSON.parse(json))\n    if (get(canOptions).isChoosen && get(canOptions).state === 'solutions') {\n      // c'est la can et on est en mode solutions\n      figure.divButtons.style.display = 'none'\n      figure.divUserMessage.style.display = 'none'\n    }\n  }\n  document.addEventListener(idApigeom, idApigeomFunct)\n\n  let oldZoom = 1\n  function updateZoom(event: Event): void {\n    if (!figure.container || !figure.container.id) {\n      // figure effacée, donc on annule la mise à jour...\n      document.removeEventListener('zoomChanged', updateZoom)\n      return\n    }\n    // console.log('ExZoom:' + idApigeom)\n    const customEvent = event as CustomEvent\n    const zoom = Number(customEvent.detail.zoom)\n    if (oldZoom !== zoom) {\n      oldZoom = zoom\n      // console.log('zoom:' + idApigeom + ':' + zoom)\n      if (figure != null)\n        figure.zoom(zoom, {\n          changeHeight: true,\n          changeWidth: true,\n          changeLeft: false,\n          changeBottom: false,\n        })\n    }\n  }\n  document.addEventListener('zoomChanged', updateZoom)\n\n  function updateAffichage(): void {\n    if (!figure.container || !figure.container.id) {\n      // figure effacée, donc on annule la mise à jour...\n      document.removeEventListener('exercicesAffiches', updateAffichage)\n      document.removeEventListener('zoomChanged', updateZoom)\n      document.removeEventListener(idApigeom, idApigeomFunct)\n      return\n    }\n    // console.log('ExAff:' + idApigeom)\n    if (!context.isHtml) {\n      // document.removeEventListener('exercicesAffiches', updateAffichage)\n      return\n    }\n    const container = document.querySelector(`#${idApigeom}`) as HTMLDivElement\n    // alert('container:' + figure.id + ':' + container)\n    if (container == null) {\n      // document.removeEventListener('exercicesAffiches', updateAffichage)\n      return\n    }\n    container.innerHTML = ''\n    figure.setContainer(container)\n    if (animation) {\n      figure.divUserMessage.innerHTML = ''\n      figure.restart()\n      setTimeout(() => {\n        figure.buttons.get('PLAY')?.click()\n      }, 3000)\n    }\n    if (defaultAction) {\n      figure.buttons.get(defaultAction)?.click()\n      // MGu que la première fois\n      defaultAction = ''\n    }\n    const zoom = Number(get(globalOptions).z)\n    if (oldZoom !== zoom) {\n      oldZoom = zoom\n      // console.log('ExAff:' + idApigeom + ':' + zoom)\n      figure.zoom(zoom, {\n        changeHeight: true,\n        changeWidth: true,\n        changeLeft: false,\n        changeBottom: false,\n      })\n    }\n  }\n  document.addEventListener('exercicesAffiches', updateAffichage)\n\n  return `<div class=\"m-6 leading-none\" id=\"${idApigeom}\"></div><span id=\"resultatCheckEx${exercice.numeroExercice}Q${i}\"></span><div class=\"ml-2 py-2 text-coopmaths-warn-darkest dark:text-coopmathsdark-warn-darkest\" id=\"feedbackEx${exercice.numeroExercice}Q${i}\"></div>`\n}\n"],"names":["figureApigeom","exercice","figure","animation","i","defaultAction","idAddendum","isDynamic","context","idApigeom","idApigeomFunct","event","json","get","canOptions","oldZoom","updateZoom","zoom","updateAffichage","container","_a","globalOptions"],"mappings":"yGAgBA,SAAwBA,EAAc,CACpC,SAAAC,EACA,OAAAC,EACA,UAAAC,EAAY,GACZ,EAAAC,EACA,cAAAC,EACA,WAAAC,EAAa,GACb,UAAAC,CACF,EAaW,CACT,GAAI,CAACC,EAAQ,OAAQ,MAAO,GAE5BN,EAAO,UAAYK,IAAc,OAAYA,EAAY,CAAC,CAACN,EAAS,WACpEC,EAAO,WAAW,MAAM,QAAUA,EAAO,UAAY,OAAS,OAC9DA,EAAO,eAAe,MAAM,SAAW,MACvCA,EAAO,eAAe,MAAM,cAAgB,OAC5CA,EAAO,eAAe,MAAM,eAAe,OAAO,EAClDA,EAAO,eAAe,UAAU,IAAI,uBAAuB,EACtDD,EAAS,aACZC,EAAO,eAAe,MAAM,QAAU,QAExC,MAAMO,EAAY,YAAYR,EAAS,cAAc,IAAIG,CAAC,GAAGE,CAAU,GACvEJ,EAAO,GAAKO,EAIZ,SAASC,EAAeC,EAAoB,CAC1C,GAAI,CAACT,EAAO,UAAW,CAErB,SAAS,oBAAoBO,EAAWC,CAAc,EACtD,MACF,CAEA,MAAME,EADcD,EACK,OACzBT,EAAO,SAAS,KAAK,MAAMU,CAAI,CAAC,EAC5BC,EAAIC,CAAU,EAAE,WAAaD,EAAIC,CAAU,EAAE,QAAU,cAEzDZ,EAAO,WAAW,MAAM,QAAU,OAClCA,EAAO,eAAe,MAAM,QAAU,OAE1C,CACA,SAAS,iBAAiBO,EAAWC,CAAc,EAEnD,IAAIK,EAAU,EACd,SAASC,EAAWL,EAAoB,CACtC,GAAI,CAACT,EAAO,WAAa,CAACA,EAAO,UAAU,GAAI,CAE7C,SAAS,oBAAoB,cAAec,CAAU,EACtD,MACF,CAGA,MAAMC,EAAO,OADON,EACY,OAAO,IAAI,EACvCI,IAAYE,IACdF,EAAUE,EAENf,GAAU,MACZA,EAAO,KAAKe,EAAM,CAChB,aAAc,GACd,YAAa,GACb,WAAY,GACZ,aAAc,EAAA,CACf,EAEP,CACA,SAAS,iBAAiB,cAAeD,CAAU,EAEnD,SAASE,GAAwB,OAC/B,GAAI,CAAChB,EAAO,WAAa,CAACA,EAAO,UAAU,GAAI,CAE7C,SAAS,oBAAoB,oBAAqBgB,CAAe,EACjE,SAAS,oBAAoB,cAAeF,CAAU,EACtD,SAAS,oBAAoBP,EAAWC,CAAc,EACtD,MACF,CAEA,GAAI,CAACF,EAAQ,OAEX,OAEF,MAAMW,EAAY,SAAS,cAAc,IAAIV,CAAS,EAAE,EAExD,GAAIU,GAAa,KAEf,OAEFA,EAAU,UAAY,GACtBjB,EAAO,aAAaiB,CAAS,EACzBhB,IACFD,EAAO,eAAe,UAAY,GAClCA,EAAO,QAAA,EACP,WAAW,IAAM,QACfkB,EAAAlB,EAAO,QAAQ,IAAI,MAAM,IAAzB,MAAAkB,EAA4B,OAC9B,EAAG,GAAI,GAELf,KACFe,EAAAlB,EAAO,QAAQ,IAAIG,CAAa,IAAhC,MAAAe,EAAmC,QAEnCf,EAAgB,IAElB,MAAMY,EAAO,OAAOJ,EAAIQ,CAAa,EAAE,CAAC,EACpCN,IAAYE,IACdF,EAAUE,EAEVf,EAAO,KAAKe,EAAM,CAChB,aAAc,GACd,YAAa,GACb,WAAY,GACZ,aAAc,EAAA,CACf,EAEL,CACA,gBAAS,iBAAiB,oBAAqBC,CAAe,EAEvD,qCAAqCT,CAAS,oCAAoCR,EAAS,cAAc,IAAIG,CAAC,kHAAkHH,EAAS,cAAc,IAAIG,CAAC,UACrQ"}