import{c as l}from"./ansi-styles-C5UZWym2.js";import{e as P}from"./eventemitter3-6E4L_h32.js";var m={},f={},R=l&&l.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,e){r.__proto__=e}||function(r,e){for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t])};return function(r,e){n(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}();Object.defineProperty(f,"__esModule",{value:!0});var C=function(n){R(r,n);function r(e,t,i){var o=n.call(this,"Error #"+e+": "+t)||this;return o.code=e,o.message=t,o.path=i,Object.setPrototypeOf(o,r.prototype),o}return r.prototype.toReplyError=function(){return{code:this.code,message:this.message,path:this.path}},r}(Error);f.RPCError=C;var d={};Object.defineProperty(d,"__esModule",{value:!0});var O=function(){function n(){this.lastSequentialCall=-1,this.queue=[]}return n.prototype.reset=function(r){this.lastSequentialCall=r-1,this.queue=[]},n.prototype.append=function(r){if(r.counter<=this.lastSequentialCall+1){var e=[r];return this.lastSequentialCall=r.counter,this.replayQueue(e),e}for(var t=0;t<this.queue.length;t++)if(this.queue[t].counter>r.counter)return this.queue.splice(t,0,r),[];return this.queue.push(r),[]},n.prototype.replayQueue=function(r){for(;this.queue.length;){var e=this.queue[0];if(e.counter>this.lastSequentialCall+1)return;r.push(this.queue.shift()),this.lastSequentialCall=e.counter}},n}();d.Reorder=O;var p={};Object.defineProperty(p,"__esModule",{value:!0});function q(n){return(n.type==="method"||n.type==="reply")&&typeof n.counter=="number"}p.isRPCMessage=q;p.defaultRecievable={readMessages:function(n){return window.addEventListener("message",n),function(){return window.removeEventListener("message",n)}}};var E=l&&l.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,e){r.__proto__=e}||function(r,e){for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t])};return function(r,e){n(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}();Object.defineProperty(m,"__esModule",{value:!0});var w=P,_=f,I=d,y=p;function M(n){return new _.RPCError(n.code,n.message,n.path)}var v=-1,S=function(n){E(r,n);function r(e){var t=n.call(this)||this;return t.options=e,t.calls=Object.create(null),t.callCounter=0,t.reorder=new I.Reorder,t.listener=function(i){if(!(t.options.origin&&t.options.origin!=="*"&&i.origin!==t.options.origin)){var o;try{o=JSON.parse(i.data)}catch{return}if(!(!y.isRPCMessage(o)||o.serviceID!==t.options.serviceId)){if(t.isReadySignal(o)){var s=o.type==="method"?o.params:o.result;s&&s.protocolVersion?t.remoteProtocolVersion=s.protocolVersion:t.remoteProtocolVersion=t.remoteProtocolVersion,t.callCounter=0,t.reorder.reset(o.counter),t.emit("isReady",!0)}for(var u=0,c=t.reorder.append(o);u<c.length;u++){var a=c[u];t.emit("recvData",a),t.dispatchIncoming(a)}}}},t.unsubscribeCallback=(e.receiver||y.defaultRecievable).readMessages(t.listener),t.isReady=new Promise(function(i){var o={protocolVersion:e.protocolVersion||"1.0"};t.expose("ready",function(){return i(),o}),t.call("ready",o).then(i).catch(i)}),t}return r.prototype.create=function(e){var t=new r(e);return t.isReady.then(function(){return t})},r.prototype.expose=function(e,t){var i=this;return this.on(e,function(o){if(o.discard){t(o.params);return}new Promise(function(s){return s(t(o.params))}).then(function(s){return{type:"reply",serviceID:i.options.serviceId,id:o.id,result:s}}).catch(function(s){return{type:"reply",serviceID:i.options.serviceId,id:o.id,error:s instanceof _.RPCError?s.toReplyError():{code:0,message:s.stack||s.message}}}).then(function(s){i.emit("sendReply",s),i.post(s)})}),this},r.prototype.call=function(e,t,i){var o=this;i===void 0&&(i=!0);var s=e==="ready"?v:this.callCounter,u={type:"method",serviceID:this.options.serviceId,id:s,params:t,method:e,discard:!i};if(this.emit("sendMethod",u),this.post(u),!!i)return new Promise(function(c,a){o.calls[s]=function(h,g){h?a(h):c(g)}})},r.prototype.destroy=function(){this.emit("destroy"),this.unsubscribeCallback()},r.prototype.remoteVersion=function(){return this.remoteProtocolVersion},r.prototype.handleReply=function(e){var t=this.calls[e.id];t&&(e.error?t(M(e.error),null):t(null,e.result),delete this.calls[e.id])},r.prototype.post=function(e){e.counter=this.callCounter++,this.options.target.postMessage(JSON.stringify(e),this.options.origin||"*")},r.prototype.isReadySignal=function(e){return e.type==="method"&&e.method==="ready"||e.type==="reply"&&e.id===v},r.prototype.dispatchIncoming=function(e){switch(e.type){case"method":if(this.emit("recvMethod",e),this.listeners(e.method).length>0){this.emit(e.method,e);return}this.post({type:"reply",serviceID:this.options.serviceId,id:e.id,error:{code:4003,message:'Unknown method name "'+e.method+'"'},result:null});break;case"reply":this.emit("recvReply",e),this.handleReply(e);break}},r}(w.EventEmitter),x=m.RPC=S;export{x as R};
//# sourceMappingURL=mixer_postmessage-rpc-Knoq2TfA.js.map
